<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="d3-tip.js"></script>

<!-- Create a div where the graph will take place -->
<h1>Star Wars Legends vs. Canon</h1>
<p><i>Hover over an event for more details.</i></p>
<!-- <div id="my_dataviz"></div> -->
<p>Haven't watched something? Don't want spoilers? Uncheck a box to filter out events from that piece of media in the timeline.</p>
    <div id="filter" class="form-item form-checkboxes checkbox">
        <form method="post" action="" class="form"></form>
    </div>
<div id="events_eventline"></div>
<style>
@import url(https://fonts.googleapis.com/css?family=News+Cycle:400,700);

body {
  background: black;
  background-image: url('https://prod-ripcut-delivery.disney-plus.net/v1/variant/disney/A11FF0C824A45B7D466AA336DC07F3D5AEF32E94A8E31ED9E6FEC67551C744CA/scale?aspectRatio=1.78&format=jpeg');
  background-size: 100%;
  font: "News Cycle", sans-serif;
}

text {
	/*fill: white;*/
	/*font-family: Helvetica, sans-serif;*/
	font-family: "News Cycle", sans-serif;
	font-weight: bold;
}

svg {
	display: block;
	margin: auto;
}

h1, p, label {
	fill: white;
	color: white;
	font-family: "News Cycle", sans-serif;
}

.axis line {
  fill: white;
  /*stroke: #000;*/
  stroke: white;
  /*shape-rendering: crispEdges;*/
}

.axis text {
  fill: white;
}

.axis path {
  /*fill: white;*/
}

.d3-tip {
  line-height: 1.4;
  padding: 12px;
  background: white;
  color: black;
  border-radius:  2px;
  border: 2px;
  border-color: black;
  font-size: 12px;
  font-family: Helvetica Neue;
  width: 300px;
  box-shadow: 3px 3px 1px lightgrey;

}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  width: 100%;
  line-height: 1;
  color: rgba(200, 200, 200, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>
<!-- <script type="text/javascript" src="canon-timeline.js"></script> -->
<script>
	// console.log(window.screen.width)
var eventMargin = {top: 30, right: 30, bottom: 30, left: 30},
    eventHeight = 5000 - eventMargin.left - eventMargin.right,
    eventWidth = (1097.8010471204188 - eventMargin.top - eventMargin.bottom);

// append the canoneventline object to the body of the page
var svg = d3.select("#events_eventline")
  .append("svg")
    .attr("width", eventWidth + eventMargin.left + eventMargin.right)
    .attr("height", eventHeight + eventMargin.top + eventMargin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + eventMargin.left + "," + eventMargin.top + ")");

//Build checkboxes
var filter_list = ["OT", "PT", "ST", "TCW", "M", "Rebels", "Resistance", "Other"]

d3.select("#filter")
    .selectAll("input")
    .data(filter_list)
    .enter()
    .append("label")
    .append("input")
    .attr("type", "checkbox")
    .attr("class", "filter-check")
    .property("checked", true)
    .attr("value", function (d) {
        return d
    })
    .attr("id", function (d) {
        return d
    });

d3.selectAll("label")
    .data(filter_list)
    .attr("class", "checkbox")	    	    
    .append("text").text(function (d) {
        return " " + d
    })	
    .attr("fill", "white")
    .attr('font-color', "white")    

var formatDate = d=> d < 0 ? `${d3.format(",")(-d)} BBY` : `${d} ABY`
//unnecessary
var num_cols = 5;

function loadTimeline(choices) {
	d3.csv("starwars_src_cleaned.csv", function(data) {
		d3.selectAll(".rect-event").remove();
		d3.select("#vline").remove();

		var years = d3.set(data.map(function(d) {return d.start})).values();
		var sz = (eventHeight - eventMargin.bottom - eventMargin.top)/years.length;

		if (choices.length > 0) {
		    data = data.filter(function (d, i) {
		    	return choices.indexOf(d["source_cleaned"]) >= 0;
		        // return _.includes(decodeURIComponent(choices), d["source_cleaned"]);
		    });
		} else {
		    data = csv; // so that no boxes checked shows all data
		}

		//nest data by era
		var sumstat = d3.nest()
			.key(function(d) { return d.era_cleaned;})
			.entries(data);

		var eras = sumstat.map(function(d){return d.key});    

		//master color scheme
		var swcolors_master = ["#A1A333", "#D5BE78", "#EFAF82", "#E7250A", "#9E5B60", "#0E5AA1", "#5FA0DE", "#453110", "#FBFFFE", "#3D5E78", "#D8DA8E", "#0C9198", "#353E9F", "#027693", "#A7281C", "#FBA411", "#0387E9", "#F26C28", "#BFAB87", "#E7250A", "#5AC2F1", "#8A2239", "#1D652F", "#32E6AC", "#AF639E", "#343D9D"]

		var color = d3.scaleOrdinal()
				.domain(eras)
				.range(swcolors_master)	

		var years = d3.set(data.map(function(d) {return d.start})).values();

		var y = d3.scaleBand()
			.domain(years)
			.range([0, eventHeight - eventMargin.top - eventMargin.bottom])

		var x = d3.scaleLinear()
			.domain([-d3.max(data, function(d) { return +d["y-key"]/2; }), d3.max(data, function(d) { return +d["y-key"]/2; })])
			.range([0, eventWidth - eventMargin.left - eventMargin.right])

		var startDate = d3.min(data, function(d) { return +d.start; });
		var endDate = d3.max(data, function(d) { return +d.start; });
		var num_days = (endDate)- (startDate)
		var w_axis = x(endDate)-x(startDate)

	  	// var sz = (eventHeight - eventMargin.bottom - eventMargin.top)/years.length;

	  	//width calc
	  	//console.log(d3.max(data, function(d) { return +d["y-key"]})*sz + eventMargin.left + eventMargin.right)

		var tip = d3.tip()
		 .attr('class', 'd3-tip')
		 .offset(d => [-10, 0])
		 .html(function(d) {
		  // console.log(d);
		   return "<div>" +
		           "<span style='color:black; font-weight:600'>" + formatDate(d.start) + "</span>" + 
		           "<span style='color:" + color(d.era_cleaned) + "; font-weight:600'> (" + d.era_cleaned + ")</span><br/>" +
		           "<span style='color:black'>" + d.event_cleaned + "</span><br/><br/>" +
		           "<span style='color:black'>Source Text: " + d.source_text + "</span><br/>"
		           "</div>"
		 })
		svg.call(tip)	  

		svg.selectAll("rect")
		 .data(data)
		 .enter()
		 .append("rect")
		 .attr("class", "rect-event")
		 .attr("x", function(d, i) {
				if (d["type"] != "Legends") {	 			
		 			return x(-Math.floor((+d["sub-key"])/2)-1)
		 		}
		 		else {
		 			return x(Math.floor((+d["sub-key"])/2)+1)
		 		}
		 })
		 .attr("y", function(d, i) {
		 		// return y(Math.floor((+d["y-key"])/num_cols));
		 		return y(d["start"])
		 })
		 .attr("width", sz/1.4)
		 .attr("height", sz/1.4)
		 .style("fill", function(d) {
		 		return color(d.era_cleaned)
		 })
		 .on('mouseover', function(d) {
		   tip.show(d, this)
		   d3.select(this).attr('fill', 'lightgray')                      
		  })
		 .on('mouseout', function(d) {
		   tip.hide(d, this)
		   d3.select(this).attr('fill', color(d.era_cleaned))
		 })	 

		svg.append("line")
			.attr("id", "vline")
		 	.attr("x1", x(0) + sz/2)
		 	.attr("x2", x(0) + sz/2)  
		 	.attr("y1", 0)
		 	.attr("y2", eventHeight - eventMargin.top - eventMargin.bottom) 
		 	.attr("stroke", "white")
		 	.attr("stroke-width", 1)	
		 	.attr("tranform", "translate(" + sz + "," + sz + ")")

		 // .on("mouseover", etc.)
	})

 // Parse the Data
}

loadTimeline(filter_list);

var checkBox = d3.selectAll(".filter-check")

checkBox.on("change", function () {
	var choices = []
	var checkboxes = document.querySelectorAll('input[type=checkbox]:checked')
	for (var i = 0; i < checkboxes.length; i++) {
	    choices.push(encodeURIComponent(checkboxes[i].value))
	}

	loadTimeline(choices);
	// feeding data filtered from choices array
	// if (choices.length > 0) {
	//     data = csv.filter(function (d, i) {
	//         return _.includes(decodeURIComponent(choices), d[filter_on]);
	//     });
	// } else {
	//     data = csv; // so that no boxes checked shows all data
	// }
	// update url with help of new choices array

	 
})
	// d3.csv("starwars_src_cleaned.csv", function(data) {

	// 	//nest data by era
	// 	var sumstat = d3.nest()
	// 		.key(function(d) { return d.era_cleaned;})
	// 		.entries(data);

	// 	var eras = sumstat.map(function(d){return d.key});    

	// 	//master color scheme
	// 	var swcolors_master = ["#A1A333", "#D5BE78", "#EFAF82", "#E7250A", "#9E5B60", "#0E5AA1", "#5FA0DE", "#453110", "#FBFFFE", "#3D5E78", "#D8DA8E", "#0C9198", "#353E9F", "#027693", "#A7281C", "#FBA411", "#0387E9", "#F26C28", "#BFAB87", "#E7250A", "#5AC2F1", "#8A2239", "#1D652F", "#32E6AC", "#AF639E", "#343D9D"]

	// 	var color = d3.scaleOrdinal()
	// 			.domain(eras)
	// 			.range(swcolors_master)	

	// 	var years = d3.set(data.map(function(d) {return d.start})).values();

	// 	var y = d3.scaleBand()
	// 		.domain(years)
	// 		.range([0, eventHeight - eventMargin.top - eventMargin.bottom])

	// 	var x = d3.scaleLinear()
	// 		.domain([-d3.max(data, function(d) { return +d["y-key"]/2; }), d3.max(data, function(d) { return +d["y-key"]/2; })])
	// 		.range([0, eventWidth - eventMargin.left - eventMargin.right])

	// 	var startDate = d3.min(data, function(d) { return +d.start; });
	// 	var endDate = d3.max(data, function(d) { return +d.start; });
	// 	var num_days = (endDate)- (startDate)
	// 	var w_axis = x(endDate)-x(startDate)

	//   	var sz = (eventHeight - eventMargin.bottom - eventMargin.top)/years.length;

	//   	//width calc
	//   	//console.log(d3.max(data, function(d) { return +d["y-key"]})*sz + eventMargin.left + eventMargin.right)

	// 	var tip = d3.tip()
	// 	 .attr('class', 'd3-tip')
	// 	 .offset(d => [-10, 0])
	// 	 .html(function(d) {
	// 	  // console.log(d);
	// 	   return "<div>" +
	// 	           "<span style='color:black; font-weight:600'>" + formatDate(d.start) + "</span>" + 
	// 	           "<span style='color:" + color(d.era_cleaned) + "; font-weight:600'> (" + d.era_cleaned + ")</span><br/>" +
	// 	           "<span style='color:black'>" + d.event_cleaned + "</span><br/><br/>" +
	// 	           "<span style='color:black'>Source Text: " + d.source_text + "</span><br/>"
	// 	           "</div>"
	// 	 })
	// 	svg.call(tip)	  

	// 	svg.selectAll("rect")
	// 	 .data(data)
	// 	 .enter()
	// 	 .append("rect")
	// 	 .attr("x", function(d, i) {
	// 			if (d["type"] != "Legends") {	 			
	// 	 			return x(-Math.floor((+d["sub-key"])/2)-1)
	// 	 		}
	// 	 		else {
	// 	 			return x(Math.floor((+d["sub-key"])/2)+1)
	// 	 		}
	// 	 })
	// 	 .attr("y", function(d, i) {
	// 	 		// return y(Math.floor((+d["y-key"])/num_cols));
	// 	 		return y(d["start"])
	// 	 })
	// 	 .attr("width", sz/1.4)
	// 	 .attr("height", sz/1.4)
	// 	 .style("fill", function(d) {
	// 	 		return color(d.era_cleaned)
	// 	 })
	// 	 .on('mouseover', function(d) {
	// 	   tip.show(d, this)
	// 	   d3.select(this).attr('fill', 'lightgray')                      
	// 	  })
	// 	 .on('mouseout', function(d) {
	// 	   tip.hide(d, this)
	// 	   d3.select(this).attr('fill', color(d.era_cleaned))
	// 	 })	 

	// 	svg.append("line")
	// 	 	.attr("x1", x(0))
	// 	 	.attr("x2", x(0))  
	// 	 	.attr("y1", 0)
	// 	 	.attr("y2", eventHeight) 
	// 	 	.attr("stroke", "white")
	// 	 	.attr("stroke-width", 1)	

	// 	 // .on("mouseover", etc.)
	// })	
	
</script>
<!-- <script type="text/javascript" src="events-eventline.js"></script> -->
