<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="d3-tip.js"></script>

<!-- Create a div where the graph will take place -->
<h1>Star Wars Legends vs. Canon</h1>
<p><i>Hover over an event for more details.</i></p>
<!-- <div id="my_dataviz"></div> -->
<p>The Star Wars saga, at a glance</p>
<div id="events_eventline"></div>
<style>
@import url(https://fonts.googleapis.com/css?family=News+Cycle:400,700);

body {
  background: black;
  background-image: url('https://prod-ripcut-delivery.disney-plus.net/v1/variant/disney/A11FF0C824A45B7D466AA336DC07F3D5AEF32E94A8E31ED9E6FEC67551C744CA/scale?aspectRatio=1.78&format=jpeg');
  background-size: 100%;
  font: "News Cycle", sans-serif;
}

text {
	/*fill: white;*/
	/*font-family: Helvetica, sans-serif;*/
	font-family: "News Cycle", sans-serif;
	font-weight: bold;
}

svg {
	display: block;
	margin: auto;
}

h1, p {
	fill: white;
	color: white;
	font-family: "News Cycle", sans-serif;
}

.axis line {
  fill: white;
  /*stroke: #000;*/
  stroke: white;
  /*shape-rendering: crispEdges;*/
}

.axis text {
  fill: white;
}

.axis path {
  /*fill: white;*/
}

.d3-tip {
  line-height: 1.4;
  padding: 12px;
  background: white;
  color: black;
  border-radius:  2px;
  border: 2px;
  border-color: black;
  font-size: 12px;
  font-family: Helvetica Neue;
  width: 300px;
  box-shadow: 3px 3px 1px lightgrey;

}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  width: 100%;
  line-height: 1;
  color: rgba(200, 200, 200, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>
<!-- <script type="text/javascript" src="canon-timeline.js"></script> -->
<script>
	// console.log(window.screen.width)
var eventMargin = {top: 30, right: 30, bottom: 30, left: 50},
    eventHeight = 5000 - eventMargin.left - eventMargin.right,
    eventWidth = (1097.8010471204188 - eventMargin.top - eventMargin.bottom);

// append the canoneventline object to the body of the page
var svg = d3.select("#events_eventline")
  .append("svg")
    .attr("width", eventWidth + eventMargin.left + eventMargin.right)
    .attr("height", eventHeight + eventMargin.top + eventMargin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + eventMargin.left + "," + eventMargin.top + ")");

// Parse the Data
d3.csv("starwars_final_v3.csv", function(data) {

	console.log(data)	
	var formatDate = d=> d < 0 ? `${d3.format(",")(-d)} BBY` : `${d} ABY`

	var num_cols = 5;

	var sumstat = d3.nest() // nest function allows to group the calculation per level of a factor
	.key(function(d) { return d.era;})
	.entries(data);
	// data = data.filter(function(d) {return d.type == "Legends"})
	var eras = sumstat.map(function(d){return d.key});    

	// var swcolors = ["#D7C078", "#E7250A","#0087E9","#5AC2F0", "#32E6AC", "#AF639E", "#343D9C"]
	var swcolors = ["#A1A333", "#EFAF82", "#9E5A60", "#0E5AA1", "#5FA0DE", "#453010",
					"#FBFFFE", "#3D5E78", "#D8DA8E", "#0C9197", "#353D9E",  "#007693",
					"#A7281C", "#FAA312", "#F26C28", "#BFAB87", "#E7250A", "#8A2238", "#1D652F"]
	var color = d3.scaleOrdinal()
			.domain(eras)
			// .range(["red", "orange", "yellow", "green", "blue", "purple"])
			.range(swcolors)	
	console.log(color("Imperial Period"))			
	// data = data.filter(function(d) {return +d.start <= -5000 })	
	// data = data.filter(function(d) {return +d.start >= -20 })	

	console.log(d3.set(data.map(function(d) {return d.start})).values())
	console.log(eras)
	console.log(eras.length)

	var years = d3.set(data.map(function(d) {return d.start})).values();

	var y = d3.scaleBand()
		.domain(years)
		.range([0, eventHeight - eventMargin.top - eventMargin.bottom])

	// var x = d3.scaleLinear()
 //      .domain([d3.min(data, d => +d.start), d3.max(data, d => +d.start)])
 //      .range([0, eventWidth - eventMargin.left - eventMargin.right])	

	var x = d3.scaleLinear()
	.domain([-d3.max(data, function(d) { return +d["y-key"]/2; }), d3.max(data, function(d) { return +d["y-key"]/2; })])
	// .range([eventHeight - eventMargin.bottom - eventMargin.top, 0])
	.range([0, eventWidth - eventMargin.left - eventMargin.right])

    // axisTop = d3.axisTop(xOrd)
    // // .tickPadding(2)
    // .tickFormat(formatDate) 
    // .tickValues(xOrd.domain().filter(function(d,i){ return !(i%50)}));

    //comment out
         

	var startDate = d3.min(data, function(d) { return +d.start; });
	var endDate = d3.max(data, function(d) { return +d.start; });
	var num_days = (endDate)- (startDate)
	var w_axis = x(endDate)-x(startDate)

	console.log((eventHeight - eventMargin.bottom - eventMargin.top)/years.length)
	// var scale_factor_2 = (w_axis)/num_days/num_cols	

  	var sz = (eventHeight - eventMargin.bottom - eventMargin.top)/years.length;
  	console.log(sz)
  	console.log((eventWidth - eventMargin.left - eventMargin.right)/d3.max(data, function(d) { return +d["y-key"]}))
  	console.log(d3.max(data, function(d) { return +d["y-key"]})*sz + eventMargin.left + eventMargin.right)
  	// var szH = (eventHeight - eventMargin.bottom - eventMargin.top)/d3.max(data, function(d) { return +d["y-key"]; });
  	// var scale_factor_2 = sz;
   //  svg
	  // .append("g")
	  // .attr("class", "axis")
	  // // .attr("transform", (d,i)=>`translate(${0} ${eventHeight-eventMargin.bottom})`)
	  // .call(axisTop)

	var tip = d3.tip()
	 .attr('class', 'd3-tip')
	 .offset(d => [-10, 0])
	 .html(function(d) {
	  // console.log(d);
	   return "<div>" +
	           "<span style='color:black; font-weight:600'>" + formatDate(d.start) + "</span>" + 
	           "<span style='color:" + color(d.era) + "; font-weight:600'> (" + d.era + ")</span><br/>" +
	           "<span style='color:black'>" + d.event_cleaned + "</span><br/><br/>" +
	           "<span style='color:black'>Source Text: " + d.source_text + "</span><br/>"
	           "</div>"
	 })
	svg.call(tip)	  

	svg.selectAll("rect")
	 .data(data)
	 .enter()
	 .append("rect")
	 .attr("x", function(d, i) {
	 		// console.log(xOrd(d.start))
	 		// return x(+d.start);
	 		// if (+d["pivot"] % 2 == 0) {
			if (d["type"] != "Legends") {	 			
	 			return x(-Math.floor((+d["sub-key"])/2)-1)
	 		}
	 		else {
	 			return x(Math.floor((+d["sub-key"])/2)+1)
	 		}
	 		// return x(d["y-key"])
	 })
	 // .attr("transform", function(d) {
	 // 		return "translate(" + scale_factor_2*((+d["y-key"]) % num_cols) + ",0)";
	 // 		// return "translate(0, " + sz*0.5 + ""
	 // })
	 .attr("y", function(d, i) {
	 		// return y(Math.floor((+d["y-key"])/num_cols));
	 		return y(d["start"])
	 })
	 .attr("width", sz/1.4)
	 .attr("height", sz/1.4)
	 .style("fill", function(d) {
	 		return color(d.era)
	 })
    .on('mouseover', function(d) {
    		 			console.log(d["y-key"])
	 			console.log(Math.floor(+d["y-key"], 2))
      tip.show(d, this)
      d3.select(this).attr('fill', 'lightgray')                      
    })
    .on('mouseout', function(d) {
      tip.hide(d, this)
      d3.select(this).attr('fill', color(d.era))
    })	 
	 // .on("mouseover", etc.)
	   
	// const spacingBetweenLegend  = 10
	// var eventMarginLeft = 8;
 //    const legend = svg.append('g')
 //      .attr('class', 'legend')
 //      .attr('transform', 'translate(0,0)')

 //    const lg = legend.selectAll('g')
 //      .data(eras)
 //      .enter()
 //      .append('g')
 //      .attr('transform', 'translate(0,'+ -eventHeight/2 +')')

 //    lg.append('rect')
 //      .style('fill', d => color(d))
 //      .attr('x', 8)
 //      .attr('y', eventHeight/2-10)
 //      .attr('height', 10)
 //      .attr('width', 10)
 //      // .attr('cx', 8)
 //      // .attr('cy', -eventMargin.top-4)
 //      // .attr('r', 5)

 //    lg.append('text')
 //      .style('font-size', '12px')
 //      .attr('x', 25)
 //      .attr('y', eventHeight/2)
 //      .attr('fill', 'white')
 //      .text(d => d)

 //    const nodeWidth = (d) => d.getBBox().width

 //    var x_min;
 //    let offset = 0
 //    lg.each(function(d, i) {
 //      const x = offset
 //      offset += nodeWidth(this) + 10
 //      x_min = x;
 //    });

 //    var nextLine = (eventWidth - 2*eventMargin.left - 2*eventMargin.right) < x_min;
 //    var target;
 //    if (window.innerWidth <= 800) {
 //        target = eventWidth - eventMargin.left
 //    } else {
 //        target =  eventWidth / 1.6;
 //    }

 //    eventMarginLeft = nextLine == true? eventMarginLeft: 0;
 //    offset = eventMarginLeft;
 //    var yValue = 10;

 //    lg.attr('transform', function(d, i) {
 //      var x = offset      
 //      offset += nodeWidth(this) + spacingBetweenLegend
 //      var ret;
 //      if(offset >= target && nextLine) {
 //          offset = nodeWidth(this) + spacingBetweenLegend + eventMarginLeft;
 //          yValue +=20;
 //          ret = `translate(${ eventMarginLeft }, ${yValue})`
 //      } else {
 //          ret = `translate(${x}, ${yValue})`
 //      }
 //      return  ret;
 //    })

 //    legend.attr('transform', function() {
 //        if(window.innerWidth < 400 && nextLine) {
 //            return `translate(${(eventWidth - nodeWidth(this)) /  2},${-20})`
 //        } else {
 //            return `translate(${(eventWidth - nodeWidth(this)) /  2},${0})`
 //        }
 //    })   	 


})	
	
</script>
<!-- <script type="text/javascript" src="events-eventline.js"></script> -->
